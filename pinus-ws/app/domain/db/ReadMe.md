# 数据库

## 目前架构
>
> 目前设想的数据库架构
> 只使用读缓存，不使用写缓存

* 存储
  * PostgeSQL 固化层
    * 数据存入会被同步写入
    * 事务存在
    * 有数据库log可以查询

  * Redis 缓存层
    * 当数据存入时，会被同步写入缓存
    * 查询时优先查询缓存，会在逻辑模块中处理查询缓存未命中且数据不存在的时候优插入数据以保证数据库查询性能
  
* 写入流程
  * 将数据同步写入数据库，可使用事务
  * 将数据写入缓存

* 查询流程
  * 从缓存中查询数据
  * 如果缓存中有数据，直接返回
  * 如果缓存中没有数据，从数据库中查询数据

* 优点
  * 数据逻辑和数据库事务关联，不易出现数据不一致的情况
  * 数据库可以使用自增主键/外键等特性
  * 数据库stream log可以看作是操作log
* 缺点
  * 写入速度会慢
  * 写入缓存需要等待数据库写入完成
  * 可能出现正在执行数据库事务时缓存脏读的情况

## 可更改架构
>
> 如果数据库压力过大，可以考虑
> 使用读写缓存

* 写入流程
  * 将数据写入缓存，可使用事务
  * 将数据异步写入数据库，不可使用事务和自增主键

* 优点
  * 写入速度会变快
  * 可以避免正在执行事务时缓存脏读的情况
  * 可以分离操作log和数据持久化，在写入缓存时，可以将操作log写入数据库，而不需要等待数据写入数据库
* 缺点
  * 数据写入缓存后再处理数据库，数据库仅作为持久化层，和逻辑业务分离，可能导致数据不一致的情况
  * 数据库无法使用自增主键
  * 数据库无法使用事务
  * 可能出现正在执行数据库事务时缓存被改写的情况
